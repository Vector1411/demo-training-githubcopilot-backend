#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

// Script tries to locate a Firebase service account JSON in common locations
// within the project and ensures .env.local contains GOOGLE_APPLICATION_CREDENTIALS
// pointing to it. This helps local dev so `npm run dev` will pick up creds.

const cwd = process.cwd();
const candidates = [
  'serviceAccountKey.json',
  'service-account.json',
  'firebase-service-account.json',
  'firebase-admin.json',
  'service-account.dev.json'
];

function findCandidate(dir) {
  for (const name of candidates) {
    const p = path.join(dir, name);
    if (fs.existsSync(p)) return p;
  }
  // search top-level for any *service*account*.json
  const files = fs.readdirSync(dir);
  for (const f of files) {
    if (/service.*account.*\.json/i.test(f) || /firebase.*admin.*\.json/i.test(f)) {
      const p = path.join(dir, f);
      if (fs.existsSync(p)) return p;
    }
  }
  return null;
}

function ensureEnvLocal(setPath) {
  const outPath = path.join(cwd, '.env.local');
  let existing = '';
  if (fs.existsSync(outPath)) existing = fs.readFileSync(outPath, 'utf8');

  // If GOOGLE_APPLICATION_CREDENTIALS already set in .env.local or env, do nothing
  if (process.env.GOOGLE_APPLICATION_CREDENTIALS) {
    console.log('GOOGLE_APPLICATION_CREDENTIALS already set in env, skipping.');
    return;
  }
  if (/^\s*GOOGLE_APPLICATION_CREDENTIALS\s*=/.test(existing)) {
    console.log('.env.local already contains GOOGLE_APPLICATION_CREDENTIALS, skipping.');
    return;
  }

  const line = `GOOGLE_APPLICATION_CREDENTIALS=${setPath}\n`;
  const out = (existing ? existing + '\n' : '') + '# Generated by scripts/ensure-firebase-creds.js\n' + line;
  fs.writeFileSync(outPath, out, { encoding: 'utf8' });
  console.log(`Wrote GOOGLE_APPLICATION_CREDENTIALS to ${outPath}`);
}

function main() {
  const found = findCandidate(cwd);
  if (found) {
    console.log('Found service account file:', found);
    ensureEnvLocal(found);
    return;
  }
  console.log('No service account JSON found in project root. If you have credentials, place a service account JSON in project root named serviceAccountKey.json or run scripts/load-firebase-creds.js.');
}

main();
